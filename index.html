<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Assessment Form Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">
    <h1 class="text-3xl font-bold mb-6">Occupational Therapy Assessment Form Reader</h1>
    <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-2xl">
        <div class="mb-4">
            <h2 class="text-xl font-semibold">Step 1: Capture Form Images</h2>
            <p class="text-gray-600">Capture both pages of the assessment form.</p>
            <video id="video" class="w-full h-64 bg-black mt-2" autoplay></video>
            <div class="flex space-x-4 mt-2">
                <button id="capture1" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Capture Page 1</button>
                <button id="capture2" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Capture Page 2</button>
                <button id="switchCamera" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Switch Camera</button>
            </div>
            <div class="flex space-x-4 mt-4">
                <canvas id="canvas1" class="w-1/2 border hidden"></canvas>
                <canvas id="canvas2" class="w-1/2 border hidden"></canvas>
            </div>
        </div>
        <div class="mb-4">
            <h2 class="text-xl font-semibold">Step 2: Process Images</h2>
            <button id="process" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" disabled>Process Images</button>
            <p id="status" class="text-gray-600 mt-2"></p>
            <textarea id="extractedData" class="w-full h-32 mt-2 p-2 border rounded" placeholder="Extracted data will appear here for verification..."></textarea>
        </div>
        <div>
            <h2 class="text-xl font-semibold">Step 3: Generate Report</h2>
            <button id="generate" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600" disabled>Generate Report</button>
            <a id="download" class="hidden"></a>
        </div>
    </div>
    <script>
        const video = document.getElementById('video');
        const canvas1 = document.getElementById('canvas1');
        const canvas2 = document.getElementById('canvas2');
        const capture1 = document.getElementById('capture1');
        const capture2 = document.getElementById('capture2');
        const switchCameraBtn = document.getElementById('switchCamera');
        const processBtn = document.getElementById('process');
        const generateBtn = document.getElementById('generate');
        const status = document.getElementById('status');
        const extractedData = document.getElementById('extractedData');
        const downloadLink = document.getElementById('download');
        let images = { page1: null, page2: null };
        let extractedInfo = {};
        let currentFacingMode = 'environment'; // Default to back camera
        let stream = null;

        // Initialize camera with specified facing mode
        async function startCamera(facingMode) {
            // Stop existing stream if any
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode }
                });
                video.srcObject = stream;
            } catch (err) {
                status.textContent = 'Error accessing camera: ' + err.message;
            }
        }

        // Start with back camera
        startCamera(currentFacingMode);

        // Switch camera button
        switchCameraBtn.addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            startCamera(currentFacingMode);
            switchCameraBtn.textContent = `Switch to ${currentFacingMode === 'environment' ? 'Front' : 'Back'} Camera`;
        });

        // Capture image for page 1
        capture1.addEventListener('click', () => {
            canvas1.width = video.videoWidth;
            canvas1.height = video.videoHeight;
            canvas1.getContext('2d').drawImage(video, 0, 0);
            canvas1.classList.remove('hidden');
            images.page1 = canvas1.toDataURL('image/png');
            checkImages();
        });

        // Capture image for page 2
        capture2.addEventListener('click', () => {
            canvas2.width = video.videoWidth;
            canvas2.height = video.videoHeight;
            canvas2.getContext('2d').drawImage(video, 0, 0);
            canvas2.classList.remove('hidden');
            images.page2 = canvas2.toDataURL('image/png');
            checkImages();
        });

        // Enable process button when both images are captured
        function checkImages() {
            if (images.page1 && images.page2) {
                processBtn.disabled = false;
            }
        }

        // Process images with Tesseract.js
        processBtn.addEventListener('click', async () => {
            status.textContent = 'Processing images...';
            extractedInfo = {};
            try {
                for (const [page, image] of Object.entries(images)) {
                    const { data: { text } } = await Tesseract.recognize(image, 'eng', {
                        logger: m => console.log(m)
                    });
                    parseText(text, page);
                }
                extractedData.value = JSON.stringify(extractedInfo, null, 2);
                status.textContent = 'Processing complete. Verify extracted data and click Generate Report.';
                generateBtn.disabled = false;
            } catch (err) {
                status.textContent = 'Error processing images: ' + err.message;
            }
        });

        // Parse text and map to report fields
        function parseText(text, page) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const checkboxes = [
                // A. Admission Data - Past Medical History
                { field: 'Past Medical History', options: ['Dementia', 'PTB', 'COPD'] },
                // B. Home Environment
                { field: 'Accommodation', options: ['Public Housing Unit', 'Private flat', 'Village House'] },
                { field: 'Accessibility', options: ['Lift-landing', 'Non lift-landing FoS', 'Ground floor', 'steps', 'Slope'] },
                { field: 'Toilet', options: ['Sitting', 'Squatting', 'Outside home', 'Urinal or Bedpan', 'Commode'] },
                { field: 'Handrails', options: ['available', 'NA'] },
                { field: 'Bathroom', options: ['Basin & bucket', 'Tub', 'Shower', 'Shower chair', 'Hot water system'] },
                // C. Social Support
                { field: 'Social support', options: ['Lives alone', 'Lives with relatives', 'OAH resident', 'hostel resident'] },
                { field: 'Life role', options: ['Working', 'Caregiver', 'Homemaker', 'Self-maintainer', 'Being cared'] },
                { field: 'Premorbid ADL', options: ['Independent', 'Assisted', 'Dependent'] },
                { field: 'Premorbid IADL', options: ['Independent', 'Assisted', 'Dependent'] },
                { field: 'Activity level', options: ['Outdoor regular', 'Outdoor occasional', 'Homebound', 'Chairbound', 'Bedbound'] },
                { field: 'Mobility status Indoor', options: ['Unaided', 'Stick', 'SQ', 'LQ', 'Frame', 'Rollator', 'Wheelchair'] },
                { field: 'Mobility status Outdoor', options: ['Unaided', 'Stick', 'SQ', 'LQ', 'Frame', 'Rollator', 'Wheelchair'] },
                // D. Financial Assistance
                { field: 'Financial status', options: ['OAA', 'DA', 'HDA', 'CSSA', 'Family', 'Self-support', 'Pension', 'savings'] }
            ];

            // Text fields
            const textFields = [
                { label: 'DOA', key: 'Admitted hospital' },
                { label: 'DOR', key: 'Referred on' },
                { label: 'Reason of Admission', key: 'Reason of Admission' },
                { label: 'Present Diagnosis', key: 'Diagnosis' },
                { label: 'BP', key: 'BP' },
                { label: 'HR', key: 'HR' },
                { label: 'SpO2', key: 'SpO2' },
                { label: 'Modified Barthel Index', key: 'MBI' },
                { label: 'MoCA-5', key: 'MoCA-5' },
                { label: 'MoCA', key: 'MoCA' }
            ];

            lines.forEach(line => {
                // Checkboxes with (✓) for Past Medical History
                if (line.includes('Past Medical History')) {
                    const conditions = [];
                    checkboxes.find(cb => cb.field === 'Past Medical History').options.forEach(opt => {
                        if (line.includes(opt) && line.includes('✓')) {
                            conditions.push(opt);
                        }
                    });
                    if (conditions.length > 0) {
                        extractedInfo['Past Medical History'] = conditions.join(', ');
                    }
                }

                // Checkboxes with (●) for B, C, D sections
                checkboxes.filter(cb => cb.field !== 'Past Medical History').forEach(cb => {
                    cb.options.forEach(opt => {
                        if (line.includes(opt) && (line.includes('(●)') || line.includes('●'))) {
                            extractedInfo[cb.field] = opt;
                        }
                    });
                });

                // Text fields
                textFields.forEach(tf => {
                    if (line.includes(tf.label)) {
                        const value = line.replace(tf.label, '').replace(/[:\(\)]/g, '').trim();
                        if (value) extractedInfo[tf.key] = value;
                    }
                });

                // Attendant and Community Service (if present)
                if (line.includes('Attendant')) {
                    const match = line.match(/visited (\w+) by (\w+)/);
                    if (match) {
                        extractedInfo['Attendant'] = `visited ${match[1]} by ${match[2]}`;
                    } else {
                        const options = ['Full-time', 'Daytime alone', 'Night time alone', 'Nil'];
                        const found = options.find(opt => line.includes(opt));
                        if (found) extractedInfo['Attendant'] = found;
                    }
                }
                if (line.includes('Community Service')) {
                    const options = ['DCC', 'Elderly Centre', 'Community Centre', 'Homehelper', 'Nil'];
                    const found = options.find(opt => line.includes(opt));
                    if (found) extractedInfo['Community Service'] = found;
                }
            });
        }

        // Generate report
        generateBtn.addEventListener('click', () => {
            try {
                const report = `
Referral Details:
Referred on: ${extractedInfo['Referred on'] || ''}
Diagnosis: ${extractedInfo['Diagnosis'] || ''}${extractedInfo['Past Medical History'] ? ', ' + extractedInfo['Past Medical History'] : ''}

Reason for Referral:
${extractedInfo['Reason of Admission'] || 'For stroke rehabilitation / ADL training'}

Clinical information:
- "E" admitted ${extractedInfo['Admitted hospital'] || 'XXX hospital'} on ${extractedInfo['Admitted hospital'] || '(date)'} for CVA

< Premorbid social status: >
- Social support: ${extractedInfo['Social support'] || ''}
- Life role: ${extractedInfo['Life role'] || ''}
- Attendant: ${extractedInfo['Attendant'] || ''}
- Premorbid ADL: ${extractedInfo['Premorbid ADL'] || ''}
- Premorbid IADL: ${extractedInfo['Premorbid IADL'] || ''}
- Activity level: ${extractedInfo['Activity level'] || ''}
- Mobility status: Indoor - ${extractedInfo['Mobility status Indoor'] || ''}
                  Outdoor - ${extractedInfo['Mobility status Outdoor'] || ''}
- Community Service: ${extractedInfo['Community Service'] || ''}
- Financial status: ${extractedInfo['Financial status'] || ''}

< Home environment: >
- Accommodation: ${extractedInfo['Accommodation'] || ''}
- Accessibility: ${extractedInfo['Accessibility'] || ''}
- Toilet: ${extractedInfo['Toilet'] || ''}
- Handrails: ${extractedInfo['Handrails'] || ''}
- Bathroom: ${extractedInfo['Bathroom'] || ''}

Progress
Initial assessment / Re-assessment done at (time)
< Observation Examination: >
Vital signs stable, Afebrile
BP: ${extractedInfo['BP'] || '___ / ___ mmHg'}    HR: ${extractedInfo['HR'] || '____ bpm'}
SpO2: ${extractedInfo['SpO2'] || '____ % on room air'}

- Level of consciousness: ${extractedInfo['Level of consciousness'] || ''}
- Followed verbal command / 1-step command / gestural command
- Vision: ${extractedInfo['Vision'] || ''}
- Hearing: ${extractedInfo['Hearing'] || ''}
- Speech: ${extractedInfo['Speech'] || ''}
- Chief complaint: ${extractedInfo['Chief complaint'] || ''}

< Physical Examination: >
- Limbs power
- MMT: ${extractedInfo['MMT'] || ''}
- Muscle tone: Upper limb - Left: ${extractedInfo['Muscle tone Upper limb Left'] || ''}
                           Right: ${extractedInfo['Muscle tone Upper limb Right'] || ''}
              Lower limb - Left: ${extractedInfo['Muscle tone Lower limb Left'] || ''}
                           Right: ${extractedInfo['Muscle tone Lower limb Right'] || ''}
- AROM: Upper limb - Left: ${extractedInfo['AROM Upper limb Left'] || ''}
                    Right: ${extractedInfo['AROM Upper limb Right'] || ''}
        Lower limb - Left: ${extractedInfo['AROM Lower limb Left'] || ''}
                    Right: ${extractedInfo['AROM Lower limb Right'] || ''}
- Sensation: ${extractedInfo['Sensation'] || ''}
- Sitting balance (Static): ${extractedInfo['Sitting balance Static'] || ''}
                 (Dynamic): ${extractedInfo['Sitting balance Dynamic'] || ''}
- Standing balance (Static): ${extractedInfo['Standing balance Static'] || ''}
                  (Dynamic): ${extractedInfo['Standing balance Dynamic'] || ''}
- Functional Mobility: Bed mobility: 
                      Lying <-> sitting: 
                      Bed <-> chair: 
                      Sit <-> stand: 

For stroke cases:
< Hand assessment: >
- Affected hand: ${extractedInfo['Affected hand'] || ''}
- Dominant hand: ${extractedInfo['Dominant hand'] || ''}
- FTHUE-HK: ${extractedInfo['FTHUE-HK'] || ''}
- Shoulder pain: ${extractedInfo['Shoulder pain'] || ''}
  Onset on shoulder pain: ${extractedInfo['Onset on shoulder pain'] || ''}
  Location: ${extractedInfo['Location shoulder pain'] || ''}
  Type of pain: ${extractedInfo['Type of pain'] || ''}
- Shoulder subluxation: ${extractedInfo['Shoulder subluxation'] || ''}
- Grasp / Release: ${extractedInfo['Grasp / Release'] || ''}
- Lateral pinch: ${extractedInfo['Lateral pinch'] || ''}
- Thumb opposition: ${extractedInfo['Thumb opposition'] || ''}
- Coordination: ${extractedInfo['Coordination'] || ''}
- Nine-hole pegboard test: Left: ${extractedInfo['Nine-hole pegboard test Left'] || ''} seconds
                          Right: ${extractedInfo['Nine-hole pegboard test Right'] || ''} seconds
- Grip strength: Left: ${extractedInfo['Grip strength Left'] || ''} kgf
                Right: ${extractedInfo['Grip strength Right'] || ''} kgf
- Pinch strength: Left: ${extractedInfo['Pinch strength Left'] || ''} kgf
                 Right: ${extractedInfo['Pinch strength Right'] || ''} kgf

< Activities of Daily Living: >
Modified Barthel Index (MBI): ${extractedInfo['MBI'] || ''} / 100
- Feeding: ${extractedInfo['Feeding'] || ''} / 10 assistance
- Grooming: ${extractedInfo['Grooming'] || ''} / 5 assistance
- Dressing: ${extractedInfo['Dressing'] || ''} / 10 assistance
- Toileting: ${extractedInfo['Toileting'] || ''} / 10 assistance
- Bathing: ${extractedInfo['Bathing'] || ''} / 5 assistance
- Bed/chair transfers: ${extractedInfo['Bed/chair transfers'] || ''} / 15 assistance
- Ambulation: ${extractedInfo['Ambulation'] || ''} / 15 assistance with (walking aids)
- Stairs: ${extractedInfo['Stairs'] || ''} / 10 assistance
- Bowel Control: ${extractedInfo['Bowel Control'] || ''} / 10 assistance
- Bladder Control: ${extractedInfo['Bladder Control'] || ''} / 10 assistance

< Cognitive assessment: >
MoCA-5: ${extractedInfo['MoCA-5'] || ''} / 30
- Immediate recall: ${extractedInfo['Immediate recall'] || ''} / 5
- Verbal fluency: ${extractedInfo['Verbal fluency'] || ''} / 9
- Orientation: ${extractedInfo['Orientation'] || ''} / 6
- Delayed recall: ${extractedInfo['Delayed recall'] || ''} / 10
Education level: ${extractedInfo['Education level'] || ''}

MoCA: ${extractedInfo['MoCA'] || ''} / 30 (Done on ${extractedInfo['Referred on'] || '(date)'})
- Visuospatial & Executive functions: ${extractedInfo['Visuospatial & Executive functions'] || ''} / 5
- Naming: ${extractedInfo['Naming'] || ''} / 3
- Attention & Working memory: ${extractedInfo['Attention & Working memory'] || ''} / 6
- Language: ${extractedInfo['Language'] || ''} / 3
- Abstract thinking: ${extractedInfo['Abstract thinking'] || ''} / 2
- Delayed recall: ${extractedInfo['Delayed recall'] || ''} / 5
- Orientation: ${extractedInfo['Orientation'] || ''} / 6
Education level: ${extractedInfo['Education level'] || ''}
                `;
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                downloadLink.href = url;
                downloadLink.download = 'OT_Assessment_Report.txt';
                downloadLink.click();
                URL.revokeObjectURL(url);
                status.textContent = 'Report generated and downloaded.';
            } catch (err) {
                status.textContent = 'Error generating report: ' + err.message;
            }
        });
    </script>
</body>
</html>