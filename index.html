<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Assessment Form Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">
    <h1 class="text-3xl font-bold mb-6">Occupational Therapy Assessment Form Reader</h1>
    <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-2xl">
        <div class="mb-4">
            <h2 class="text-xl font-semibold">Step 1: Capture Form Images</h2>
            <p class="text-gray-600">Ensure camera permissions are granted in your browser settings. The preview should show your back camera feed below.</p>
            <video id="video" class="w-full h-64 bg-black mt-2" autoplay></video>
            <div id="cameraError" class="text-red-500 mt-2 hidden">
                Camera not accessible. Please grant camera permissions in your browser or device settings, then click Retry Camera.
                <button id="retryCamera" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 mt-2">Retry Camera</button>
            </div>
            <div class="flex space-x-4 mt-2">
                <button id="capture1" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Capture Page 1</button>
                <button id="capture2" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Capture Page 2</button>
                <button id="switchCamera" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Switch Camera</button>
            </div>
            <div class="flex space-x-4 mt-4">
                <canvas id="canvas1" class="w-1/2 border hidden"></canvas>
                <canvas id="canvas2" class="w-1/2 border hidden"></canvas>
            </div>
        </div>
        <div class="mb-4">
            <h2 class="text-xl font-semibold">Step 2: Process Images</h2>
            <div class="flex space-x-4 mb-2">
                <button id="process" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" disabled>Process Images</button>
                <button id="retryProcess" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 hidden">Retry with Smaller Images</button>
                <button id="clearImages" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Clear Images</button>
            </div>
            <p id="status" class="text-gray-600 mt-2"></p>
            <textarea id="extractedData" class="w-full h-32 mt-2 p-2 border rounded" placeholder="Extracted data will appear here for verification. If processing fails, you can manually enter the text..."></textarea>
        </div>
        <div>
            <h2 class="text-xl font-semibold">Step 3: Generate Report</h2>
            <button id="generate" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600" disabled>Generate Report</button>
            <a id="download" class="hidden"></a>
        </div>
    </div>
    <script>
        const video = document.getElementById('video');
        const canvas1 = document.getElementById('canvas1');
        const canvas2 = document.getElementById('canvas2');
        const capture1 = document.getElementById('capture1');
        const capture2 = document.getElementById('capture2');
        const switchCameraBtn = document.getElementById('switchCamera');
        const processBtn = document.getElementById('process');
        const retryProcessBtn = document.getElementById('retryProcess');
        const clearImagesBtn = document.getElementById('clearImages');
        const generateBtn = document.getElementById('generate');
        const status = document.getElementById('status');
        const cameraError = document.getElementById('cameraError');
        const retryCamera = document.getElementById('retryCamera');
        const extractedData = document.getElementById('extractedData');
        const downloadLink = document.getElementById('download');
        let images = { page1: null, page2: null };
        let extractedInfo = {};
        let currentFacingMode = 'environment';
        let stream = null;
        let currentMaxDimension = 400; // Start with a smaller size for faster processing

        async function startCamera(facingMode) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode }
                });
                video.srcObject = stream;
                cameraError.classList.add('hidden');
            } catch (err) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: true
                    });
                    video.srcObject = stream;
                    cameraError.classList.add('hidden');
                } catch (genericErr) {
                    cameraError.classList.remove('hidden');
                    status.textContent = `Camera access failed: ${genericErr.message || 'Unknown error'}. Please ensure camera permissions are granted and no other app is using the camera.`;
                    console.error('Camera error:', genericErr);
                }
            }
        }

        startCamera(currentFacingMode);

        retryCamera.addEventListener('click', () => {
            startCamera(currentFacingMode);
        });

        switchCameraBtn.addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            startCamera(currentFacingMode);
            switchCameraBtn.textContent = `Switch to ${currentFacingMode === 'environment' ? 'Front' : 'Back'} Camera`;
        });

        capture1.addEventListener('click', () => {
            if (!video.srcObject) {
                status.textContent = 'Camera not active. Please ensure the camera preview is working before capturing.';
                return;
            }
            canvas1.width = video.videoWidth;
            canvas1.height = video.videoHeight;
            canvas1.getContext('2d').drawImage(video, 0, 0);
            canvas1.classList.remove('hidden');
            images.page1 = canvas1.toDataURL('image/png');
            checkImages();
        });

        capture2.addEventListener('click', () => {
            if (!video.srcObject) {
                status.textContent = 'Camera not active. Please ensure the camera preview is working before capturing.';
                return;
            }
            canvas2.width = video.videoWidth;
            canvas2.height = video.videoHeight;
            canvas2.getContext('2d').drawImage(video, 0, 0);
            canvas2.classList.remove('hidden');
            images.page2 = canvas2.toDataURL('image/png');
            checkImages();
        });

        clearImagesBtn.addEventListener('click', () => {
            images = { page1: null, page2: null };
            canvas1.classList.add('hidden');
            canvas2.classList.add('hidden');
            processBtn.disabled = true;
            generateBtn.disabled = true;
            extractedData.value = '';
            status.textContent = 'Images cleared. Capture new images to proceed.';
            retryProcessBtn.classList.add('hidden');
        });

        function checkImages() {
            if (images.page1 && images.page2) {
                processBtn.disabled = false;
            }
        }

        function downscaleImage(imageDataUrl, maxDimension) {
            return new Promise((resolve, reject) => {
                try {
                    const img = new Image();
                    img.src = imageDataUrl;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > maxDimension) {
                                height = Math.round((height * maxDimension) / width);
                                width = maxDimension;
                            }
                        } else {
                            if (height > maxDimension) {
                                width = Math.round((width * maxDimension) / height);
                                height = maxDimension;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = () => reject(new Error('Failed to load image for downscaling'));
                } catch (err) {
                    reject(new Error('Downscaling error: ' + (err.message || 'Unknown error')));
                }
            });
        }

        async function processImages(maxDimension) {
            status.textContent = 'Preparing images for processing...';
            processBtn.disabled = true;
            retryProcessBtn.classList.add('hidden');
            extractedInfo = {};
            const timeoutPerImage = 30000;

            try {
                const worker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            status.textContent = `Processing ${m.jobId === 'Page 1' ? 'Page 1' : 'Page 2'}: ${(m.progress * 100).toFixed(1)}%`;
                        }
                    }
                });

                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz/()-.: ',
                    tessedit_pageseg_mode: '6',
                    tessedit_ocr_engine_mode: '1'
                });

                // Downscale images
                status.textContent = 'Downscaling Page 1...';
                const downscaledPage1 = await downscaleImage(images.page1, maxDimension);

                status.textContent = 'Downscaling Page 2...';
                const downscaledPage2 = await downscaleImage(images.page2, maxDimension);

                // Process Page 1
                status.textContent = 'Processing Page 1: 0.0%';
                const page1Promise = worker.recognize(downscaledPage1);
                const page1Result = await Promise.race([
                    page1Promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Page 1 OCR timed out')), timeoutPerImage))
                ]);
                parseText(page1Result.data.text, 'page1');

                // Process Page 2
                status.textContent = 'Processing Page 2: 0.0%';
                const page2Promise = worker.recognize(downscaledPage2);
                const page2Result = await Promise.race([
                    page2Promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Page 2 OCR timed out')), timeoutPerImage))
                ]);
                parseText(page2Result.data.text, 'page2');

                await worker.terminate();

                extractedData.value = JSON.stringify(extractedInfo, null, 2);
                status.textContent = 'Processing complete. Verify extracted data and click Generate Report.';
                generateBtn.disabled = false;
                processBtn.disabled = false;
            } catch (err) {
                const errorMessage = err.message || 'An unexpected error occurred during processing';
                status.textContent = `Error processing images: ${errorMessage}. You can retry with smaller images, manually enter the data, or clear the images and start over.`;
                console.error('Processing error:', err);
                extractedData.value = JSON.stringify(extractedInfo, null, 2);
                generateBtn.disabled = false;
                processBtn.disabled = false;
                // Show retry button with smaller image size
                currentMaxDimension = Math.max(200, currentMaxDimension - 100); // Reduce size for retry
                retryProcessBtn.classList.remove('hidden');
            }
        }

        processBtn.addEventListener('click', () => {
            processImages(currentMaxDimension);
        });

        retryProcessBtn.addEventListener('click', () => {
            status.textContent = `Retrying with smaller image size (max dimension: ${currentMaxDimension}px)...`;
            processImages(currentMaxDimension);
        });

        function parseText(text, page) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const checkboxes = [
                { field: 'Past Medical History', options: ['Dementia', 'PTB', 'COPD', 'HT', 'DM', 'Parkinson’s disease'] },
                { field: 'Activity level', options: ['Outdoor (regular/occasional)', 'Chair-bound', 'Home-bound', 'Bed-bound'] },
                { field: 'Mobility status Indoor', options: ['Unaided', 'Stick', 'Quadripod', 'Frame', 'Wheelchair'] },
                { field: 'Mobility status Outdoor', options: ['Unaided', 'Stick', 'Quadripod', 'Frame', 'Wheelchair'] },
                { field: 'Accommodation', options: ['Public housing estate', 'Private flat', 'Village house', 'Hut', 'THA', 'Private OAH', 'C&A', 'Sheltered housing', 'Nursing home'] },
                { field: 'Accessibility', options: ['Lift-landing', 'Non lift-landing', 'FOS', 'Ground floor', 'steps', 'Slope'] },
                { field: 'Toilet', options: ['Sitting', 'Urinal/bed pan', 'Commode', 'Outside home'] },
                { field: 'Bathroom', options: ['Basin & bucket', 'Tub', 'Shower', 'Shower chair', 'Hot water system', 'Boil water'] },
                { field: 'Life role', options: ['Working', 'Caregiver', 'Homemaker', 'Self-maintainer', 'Being cared'] },
                { field: 'Social support', options: ['Alone', 'Lives with relatives', 'OAH resident', 'hostel resident'] },
                { field: 'Attendant', options: ['Full time', 'Daytime alone', 'Night time alone', 'Nil'] },
                { field: 'Community Service', options: ['DCC', 'Elderly center', 'Community center', 'Homehelper', 'Nil'] },
                { field: 'Cooking', options: ['Self', 'Dining out', 'Meals-on-wheel'] },
                { field: 'Medical Services', options: ['Acute', 'Sub-acute', 'Rehab-hospital', 'Day hospital', 'OPD', 'CSSA', 'Nil'] },
                { field: 'Financial status', options: ['OAA', 'DA', 'HDA', 'CSSA', 'Family', 'Self support', 'Pension or savings'] },
                { field: 'Level of consciousness', options: ['Alert', 'Conscious', 'Drowsy', 'Stupor'] },
                { field: 'Muscle tone Upper limb Left', options: ['flaccid', 'hypo', 'hyper', 'NAD'] },
                { field: 'Muscle tone Upper limb Right', options: ['flaccid', 'hypo', 'hyper', 'NAD'] },
                { field: 'Muscle tone Lower limb Left', options: ['flaccid', 'hypo', 'hyper', 'NAD'] },
                { field: 'Muscle tone Lower limb Right', options: ['flaccid', 'hypo', 'hyper', 'NAD'] },
                { field: 'AROM UL Left S', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM UL Left E', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM UL Left W', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM UL Right S', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM UL Right E', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM UL Right W', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM LL Left H', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM LL Left K', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM LL Left A', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM LL Right H', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM LL Right K', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'AROM LL Right A', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'Sitting balance Static', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'Sitting balance Dynamic', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'Standing balance Static', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'Standing balance Dynamic', options: ['Intact', 'Impaired', 'Absent'], symbols: { '✓': 'Intact', 'O': 'Impaired', 'X': 'Absent' } },
                { field: 'Bed mobility', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Lying <-> sitting', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Bed <-> chair', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Sit <-> stand', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Feeding assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Grooming assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Dressing assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Toileting assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Bathing assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Bed/chair transfers assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Ambulation assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Stairs assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Bowel Control assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } },
                { field: 'Bladder Control assistance', options: ['Independent', 'Supervision', 'Minimal assistance', 'Moderate assistance', 'Maximal assistance', 'Dependent'], symbols: { '✓': 'Independent', 'sup': 'Supervision', 'min A': 'Minimal assistance', 'mod A': 'Moderate assistance', 'max A': 'Maximal assistance', '✗': 'Dependent' } }
            ];

            const textFields = [
                { label: 'DOA', key: 'Admitted hospital', fuzzy: ['D0A', 'DOA:'] },
                { label: 'DOR', key: 'Referred on', fuzzy: ['D0R', 'DOR:'] },
                { label: 'Date of 1st Contact', key: 'Date of 1st Contact', fuzzy: ['Date of 1st Contact:'] },
                { label: 'Reason of Admission', key: 'Reason of Admission', fuzzy: ['Reason of Admission:'] },
                { label: 'Present Diagnosis', key: 'Diagnosis', fuzzy: ['Present Diagnosis:'] },
                { label: 'Leisure', key: 'Leisure', fuzzy: ['Leisure:'] },
                { label: 'Work history', key: 'Work history', fuzzy: ['Work history:'] },
                { label: 'Premorbid ADL', key: 'Premorbid ADL', fuzzy: ['ADL:'] },
                { label: 'Premorbid IADL', key: 'Premorbid IADL', fuzzy: ['IADL:'] },
                { label: 'Walking aids', key: 'Walking aids', fuzzy: ['Walking aids:'] },
                { label: 'Limb power UL', key: 'Limb power UL', fuzzy: ['Limb power'], numeric: true },
                { label: 'Limb power LL', key: 'Limb power LL', fuzzy: ['Limb power'], numeric: true },
                { label: 'Feeding', key: 'Feeding', score: true, fuzzy: ['1. Feeding', 'Feeding:'] },
                { label: 'Personal Hygiene', key: 'Grooming', score: true, fuzzy: ['2. Personal Hygiene', 'Personal Hygiene:'] },
                { label: 'Dressing', key: 'Dressing', score: true, fuzzy: ['3. Dressing', 'Dressing:'] },
                { label: 'Toileting', key: 'Toileting', score: true, fuzzy: ['4. Toileting', 'Toileting:'] },
                { label: 'Bathing', key: 'Bathing', score: true, fuzzy: ['5. Bathing', 'Bathing:'] },
                { label: 'Bed/chair transfer', key: 'Bed/chair transfers', score: true, fuzzy: ['6. Bed/chair transfer', 'Bed/chair transfer:'] },
                { label: 'Ambulation', key: 'Ambulation', score: true, fuzzy: ['7. Ambulation', 'Ambulation:'] },
                { label: 'Stairs', key: 'Stairs', score: true, fuzzy: ['8. Stairs', 'Stairs:'] },
                { label: 'Bowel control', key: 'Bowel Control', score: true, fuzzy: ['9. Bowel control', 'Bowel control:'] },
                { label: 'Bladder control', key: 'Bladder Control', score: true, fuzzy: ['10. Bladder control', 'Bladder control:'] },
                { label: 'TOTAL', key: 'MBI', score: true, fuzzy: ['TOTAL:', 'Total:'] }
            ];

            function cleanText(str) {
                return str.replace(/[^a-zA-Z0-9\/\(\)\-\.\: ]/g, '').trim();
            }

            function fuzzyMatch(line, label, fuzzyLabels) {
                return [label, ...fuzzyLabels].some(l => line.toLowerCase().includes(l.toLowerCase()));
            }

            let limbPowerSection = false;
            let limbPowerCount = 0;

            lines.forEach(line => {
                const cleanedLine = cleanText(line);

                // Checkboxes with custom symbols
                checkboxes.forEach(cb => {
                    if (cb.symbols) {
                        Object.keys(cb.symbols).forEach(symbol => {
                            if (cleanedLine.includes(symbol)) {
                                cb.options.forEach(opt => {
                                    if (cleanedLine.includes(opt) || cb.symbols[symbol] === opt) {
                                        extractedInfo[cb.field] = cb.symbols[symbol];
                                    }
                                });
                            }
                        });
                    } else {
                        if (cb.field.includes('assistance')) {
                            cb.options.forEach(opt => {
                                if (cleanedLine.includes(opt) || (cleanedLine.includes('sup') && opt === 'Supervision') || (cleanedLine.includes('min A') && opt === 'Minimal assistance') || (cleanedLine.includes('mod A') && opt === 'Moderate assistance') || (cleanedLine.includes('max A') && opt === 'Maximal assistance')) {
                                    if (cleanedLine.includes('(✓)') || cleanedLine.includes('✓') || cleanedLine.includes('(●)') || cleanedLine.includes('●') || cleanedLine.includes('X') || cleanedLine.includes('sup') || cleanedLine.includes('min A') || cleanedLine.includes('mod A') || cleanedLine.includes('max A') || cleanedLine.includes('✗')) {
                                        extractedInfo[cb.field] = opt;
                                    }
                                }
                            });
                        } else if (cb.field === 'Past Medical History') {
                            const conditions = [];
                            cb.options.forEach(opt => {
                                if (cleanedLine.includes(opt) && (cleanedLine.includes('(✓)') || cleanedLine.includes('✓') || cleanedLine.includes('(●)') || cleanedLine.includes('●') || cleanedLine.includes('X'))) {
                                    conditions.push(opt);
                                }
                            });
                            if (conditions.length > 0) {
                                extractedInfo[cb.field] = conditions.join(', ');
                            }
                        } else {
                            cb.options.forEach(opt => {
                                if (cleanedLine.includes(opt) && (cleanedLine.includes('(✓)') || cleanedLine.includes('✓') || cleanedLine.includes('(●)') || cleanedLine.includes('●') || cleanedLine.includes('X'))) {
                                    extractedInfo[cb.field] = opt;
                                }
                            });
                        }
                    }
                });

                // Text fields with fuzzy matching
                textFields.forEach(tf => {
                    if (fuzzyMatch(cleanedLine, tf.label, tf.fuzzy || [])) {
                        let value = cleanedLine;
                        [...tf.fuzzy, tf.label].forEach(l => {
                            value = value.replace(new RegExp(l, 'i'), '');
                        });
                        value = cleanText(value);
                        if (tf.label === 'Present Diagnosis') {
                            value = value.replace(/\s*\(ICD\d+\)/g, '').trim();
                        }
                        if (tf.score) {
                            const match = value.match(/(\d+)\/(\d+)/);
                            if (match) {
                                extractedInfo[tf.key] = match[1];
                            }
                        } else if (tf.numeric) {
                            if (cleanedLine.includes('Limb power')) {
                                limbPowerSection = true;
                                limbPowerCount = 0;
                            }
                            if (limbPowerSection) {
                                const numbers = cleanedLine.match(/\d+/g);
                                if (numbers) {
                                    limbPowerCount++;
                                    if (limbPowerCount === 1) {
                                        extractedInfo['Limb power UL'] = `${numbers[0] || ''} | ${numbers[1] || ''}`;
                                    } else if (limbPowerCount === 2) {
                                        extractedInfo['Limb power LL'] = `${numbers[0] || ''} | ${numbers[1] || ''}`;
                                        limbPowerSection = false;
                                    }
                                }
                            }
                        } else if (value) {
                            extractedInfo[tf.key] = value;
                        }
                    }
                });

                if (cleanedLine.includes('ADL') && !cleanedLine.includes('(✓)') && !cleanedLine.includes('✓')) {
                    const adlItems = ['Grooming', 'Dressing', 'Toileting', 'Laundry', 'Bathing'];
                    const presentItems = adlItems.filter(item => cleanedLine.includes(item));
                    if (presentItems.length > 0) {
                        extractedInfo['Premorbid ADL'] = presentItems.join(', ');
                    }
                }
                if (cleanedLine.includes('IADL') && !cleanedLine.includes('(✓)') && !cleanedLine.includes('✓')) {
                    const iadlItems = ['Housework task', 'Cooking'];
                    const presentItems = iadlItems.filter(item => cleanedLine.includes(item));
                    if (presentItems.length > 0) {
                        extractedInfo['Premorbid IADL'] = presentItems.join(', ');
                    }
                }
            });

            if (extractedInfo['Admitted hospital']) {
                extractedInfo['Date of onset'] = extractedInfo['Admitted hospital'];
            }
        }

        generateBtn.addEventListener('click', () => {
            try {
                const report = `
Referral Details:
Referred on: ${extractedInfo['Referred on'] || ''}
Diagnosis: ${extractedInfo['Diagnosis'] || ''}${extractedInfo['Past Medical History'] ? ', ' + extractedInfo['Past Medical History'] : ''}

Reason for Referral:
${extractedInfo['Reason of Admission'] || 'For stroke rehabilitation / ADL training'}

Clinical information:
- "E" admitted ${extractedInfo['Admitted hospital'] || 'XXX hospital'} on ${extractedInfo['Admitted hospital'] || '(date)'} for CVA

< Premorbid social status: >
- Social support: ${extractedInfo['Social support'] || ''}
- Life role: ${extractedInfo['Life role'] || ''}
- Attendant: ${extractedInfo['Attendant'] || ''}
- Premorbid ADL: ${extractedInfo['Premorbid ADL'] || ''}
- Premorbid IADL: ${extractedInfo['Premorbid IADL'] || ''}
- Activity level: ${extractedInfo['Activity level'] || ''}
- Mobility status: Indoor - ${extractedInfo['Mobility status Indoor'] || ''}
                  Outdoor - ${extractedInfo['Mobility status Outdoor'] || ''}
- Community Service: ${extractedInfo['Community Service'] || ''}
- Financial status: ${extractedInfo['Financial status'] || ''}

< Home environment: >
- Accommodation: ${extractedInfo['Accommodation'] || ''}
- Accessibility: ${extractedInfo['Accessibility'] || ''}
- Toilet: ${extractedInfo['Toilet'] || ''}
- Handrails: ${extractedInfo['Handrails'] || ''}
- Bathroom: ${extractedInfo['Bathroom'] || ''}

Progress
Initial assessment / Re-assessment done at (time)
< Observation Examination: >
Vital signs stable, Afebrile
BP: ${extractedInfo['BP'] || '___ / ___ mmHg'}    HR: ${extractedInfo['HR'] || '____ bpm'}
SpO2: ${extractedInfo['SpO2'] || '____ % on room air'}

- Level of consciousness: ${extractedInfo['Level of consciousness'] || ''}
- Followed verbal command / 1-step command / gestural command
- Vision: ${extractedInfo['Vision'] || ''}
- Hearing: ${extractedInfo['Hearing'] || ''}
- Speech: ${extractedInfo['Speech'] || ''}
- Chief complaint: ${extractedInfo['Chief complaint'] || ''}

< Physical Examination: >
- Limbs power: Upper limb - Left: ${extractedInfo['Limb power UL'] ? extractedInfo['Limb power UL'].split('|')[0] : ''}, Right: ${extractedInfo['Limb power UL'] ? extractedInfo['Limb power UL'].split('|')[1] : ''}
              Lower limb - Left: ${extractedInfo['Limb power LL'] ? extractedInfo['Limb power LL'].split('|')[0] : ''}, Right: ${extractedInfo['Limb power LL'] ? extractedInfo['Limb power LL'].split('|')[1] : ''}
- MMT: ${extractedInfo['MMT'] || ''}
- Muscle tone: Upper limb - Left: ${extractedInfo['Muscle tone Upper limb Left'] || ''}
                           Right: ${extractedInfo['Muscle tone Upper limb Right'] || ''}
              Lower limb - Left: ${extractedInfo['Muscle tone Lower limb Left'] || ''}
                           Right: ${extractedInfo['Muscle tone Lower limb Right'] || ''}
- AROM: Upper limb - Left: S: ${extractedInfo['AROM UL Left S'] || ''}, E: ${extractedInfo['AROM UL Left E'] || ''}, W: ${extractedInfo['AROM UL Left W'] || ''}
                    Right: S: ${extractedInfo['AROM UL Right S'] || ''}, E: ${extractedInfo['AROM UL Right E'] || ''}, W: ${extractedInfo['AROM UL Right W'] || ''}
        Lower limb - Left: H: ${extractedInfo['AROM LL Left H'] || ''}, K: ${extractedInfo['AROM LL Left K'] || ''}, A: ${extractedInfo['AROM LL Left A'] || ''}
                    Right: H: ${extractedInfo['AROM LL Right H'] || ''}, K: ${extractedInfo['AROM LL Right K'] || ''}, A: ${extractedInfo['AROM LL Right A'] || ''}
- Sensation: ${extractedInfo['Sensation'] || ''}
- Sitting balance (Static): ${extractedInfo['Sitting balance Static'] || ''}
                 (Dynamic): ${extractedInfo['Sitting balance Dynamic'] || ''}
- Standing balance (Static): ${extractedInfo['Standing balance Static'] || ''}
                  (Dynamic): ${extractedInfo['Standing balance Dynamic'] || ''}
- Functional Mobility: Bed mobility: ${extractedInfo['Bed mobility'] || ''}
                      Lying <-> sitting: ${extractedInfo['Lying <-> sitting'] || ''}
                      Bed <-> chair: ${extractedInfo['Bed <-> chair'] || ''}
                      Sit <-> stand: ${extractedInfo['Sit <-> stand'] || ''}

For stroke cases:
< Hand assessment: >
- Affected hand: ${extractedInfo['Affected hand'] || ''}
- Dominant hand: ${extractedInfo['Dominant hand'] || ''}
- FTHUE-HK: ${extractedInfo['FTHUE-HK'] || ''}
- Shoulder pain: ${extractedInfo['Shoulder pain'] || ''}
  Onset on shoulder pain: ${extractedInfo['Onset on shoulder pain'] || ''}
  Location: ${extractedInfo['Location shoulder pain'] || ''}
  Type of pain: ${extractedInfo['Type of pain'] || ''}
- Shoulder subluxation: ${extractedInfo['Shoulder subluxation'] || ''}
- Grasp / Release: ${extractedInfo['Grasp / Release'] || ''}
- Lateral pinch: ${extractedInfo['Lateral pinch'] || ''}
- Thumb opposition: ${extractedInfo['Thumb opposition'] || ''}
- Coordination: ${extractedInfo['Coordination'] || ''}
- Nine-hole pegboard test: Left: ${extractedInfo['Nine-hole pegboard test Left'] || ''} seconds
                          Right: ${extractedInfo['Nine-hole pegboard test Right'] || ''} seconds
- Grip strength: Left: ${extractedInfo['Grip strength Left'] || ''} kgf
                Right: ${extractedInfo['Grip strength Right'] || ''} kgf
- Pinch strength: Left: ${extractedInfo['Pinch strength Left'] || ''} kgf
                 Right: ${extractedInfo['Pinch strength Right'] || ''} kgf

< Activities of Daily Living: >
Modified Barthel Index (MBI): ${extractedInfo['MBI'] || ''} / 100
- Feeding: ${extractedInfo['Feeding'] || ''} / 10 ${extractedInfo['Feeding assistance'] || 'assistance'}
- Grooming: ${extractedInfo['Grooming'] || ''} / 5 ${extractedInfo['Grooming assistance'] || 'assistance'}
- Dressing: ${extractedInfo['Dressing'] || ''} / 10 ${extractedInfo['Dressing assistance'] || 'assistance'}
- Toileting: ${extractedInfo['Toileting'] || ''} / 10 ${extractedInfo['Toileting assistance'] || 'assistance'}
- Bathing: ${extractedInfo['Bathing'] || ''} / 5 ${extractedInfo['Bathing assistance'] || 'assistance'}
- Bed/chair transfers: ${extractedInfo['Bed/chair transfers'] || ''} / 15 ${extractedInfo['Bed/chair transfers assistance'] || 'assistance'}
- Ambulation: ${extractedInfo['Ambulation'] || ''} / 15 ${extractedInfo['Ambulation assistance'] || 'assistance'} with ${extractedInfo['Walking aids'] || ''}
- Stairs: ${extractedInfo['Stairs'] || ''} / 10 ${extractedInfo['Stairs assistance'] || 'assistance'}
- Bowel Control: ${extractedInfo['Bowel Control'] || ''} / 10 ${extractedInfo['Bowel Control assistance'] || 'assistance'}
- Bladder Control: ${extractedInfo['Bladder Control'] || ''} / 10 ${extractedInfo['Bladder Control assistance'] || 'assistance'}

< Cognitive assessment: >
MoCA-5: ${extractedInfo['MoCA-5'] || ''} / 30
- Immediate recall: ${extractedInfo['Immediate recall'] || ''} / 5
- Verbal fluency: ${extractedInfo['Verbal fluency'] || ''} / 9
- Orientation: ${extractedInfo['Orientation'] || ''} / 6
- Delayed recall: ${extractedInfo['Delayed recall'] || ''} / 10
Education level: ${extractedInfo['Education level'] || ''}

MoCA: ${extractedInfo['MoCA'] || ''} / 30 (Done on ${extractedInfo['Referred on'] || '(date)'})
- Visuospatial & Executive functions: ${extractedInfo['Visuospatial & Executive functions'] || ''} / 5
- Naming: ${extractedInfo['Naming'] || ''} / 3
- Attention & Working memory: ${extractedInfo['Attention & Working memory'] || ''} / 6
- Language: ${extractedInfo['Language'] || ''} / 3
- Abstract thinking: ${extractedInfo['Abstract thinking'] || ''} / 2
- Delayed recall: ${extractedInfo['Delayed recall'] || ''} / 5
- Orientation: ${extractedInfo['Orientation'] || ''} / 6
Education level: ${extractedInfo['Education level'] || ''}
                `;
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                downloadLink.href = url;
                downloadLink.download = 'OT_Assessment_Report.txt';
                downloadLink.click();
                URL.revokeObjectURL(url);
                status.textContent = 'Report generated and downloaded.';
            } catch (err) {
                status.textContent = 'Error generating report: ' + (err.message || 'An unexpected error occurred');
                console.error('Report generation error:', err);
            }
        });
    </script>
</body>
</html>